---
- name: automatic first installation
  hosts: localhost
  connection: local
  tasks:
    - name: Check that user exists
      shell: "grep jenkins /etc/passwd"
      ignore_errors: yes
      become: yes
      register: userexist
      
    - name: user status output
      debug:
        msg: "{{userexist.stdout}}"
   
    - name: user add
      shell: useradd jenkins
      become: yes
      when: userexist.stdout | length < 1

    - name: editing sudoers
      become: yes
      become_user: root
      lineinfile:
        path: /etc/sudoers
        line: "jenkins ALL=(ALL) NOPASSWD: ALL"
        state: present
      notify:
      - restart ssh

    - name: Pause for 2 minutes to restart ssh
      pause:
         minutes: 2  

    - name: Ansible apt to install multiple packages
      apt:
        name: "{{ item }}"
        update_cache: yes
        state: present
      with_items:
         - 'nginx'
         - 'npm'
         - 'ansible'
         - 'git'
      become: yes
      register: aptout 
      
    - debug:
         msg: "{{ aptout }}"

  handlers:
      - name: restart ssh
        become: yes
        become_user: root
        service: 
         name: ssh 
         state: restarted
